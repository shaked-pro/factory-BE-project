<html>
    <head>
      <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    </head>
    <title>Shifts Page</title>
    <body  onload="getShifts()">
      <h1>Shifts</h1></br>
      <table id="mongoTable">
        <thead>
          <tr>
            <th>Shift Id</th>
            <th>Shift date</th>
            <th>hours</th>
            <th>employees</th>
            <th>Options</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be dynamically inserted here -->
        </tbody>
      </table>
      </br>
      </br>
      <div id="allocationModal" class="modal"></div>
      <span class="close">&times;</span>
      <h3>Allocate Employee to Shift</h3>
        <select id="employeesDropDown"></select> <!--onchange="handleDropdownChange()"> -->
          <!-- Options will be populated here -->
        </select>
      </br>
      </br>
        shift ID: <input type="text" id="shiftIdInput" /><br /> <br />
      </div>
      </br>
      </br>
          <button onclick="submitEmployeeAllocation()">Allocate</button>
      <script lang="js">
        async function getShifts() {
          const response = await axios.get("http://localhost:3000/shifts", {
            headers: { 'Accept': 'application/json' }
          });
          let shifts = response.data;
          let tableBody = document.querySelector("#mongoTable tbody");
          generateTable(tableBody, shifts);
        }
        async function generateTable(table, data) {
          table.innerHTML = ""; // Clear existing rows
          for (let i = 0; i < Object.keys(data).length; i++) {
            let row = table.insertRow();
            for (let key in data[i]) {
              if (key === 'Starting_Hour' || key == 'Ending_Hour')
              {
                continue;
              }
              else if (key === 'Date')
              {
                continue;
              }
              else if (key ==='employees')
              {
                let cell = row.insertCell();
                cell.setAttribute("contenteditable", "true");
                cell.textContent = data[i][key];
                let buttonCell = row.insertCell(); // New cell for the button
                let button = document.createElement('button');
                button.textContent = 'Allocate employee to shift'; // Button text
                button.onclick = function () {
                  allocateEmployeeToSihft(data[i]._id);
                };
                buttonCell.appendChild(button);
                continue;
              }
              let cell = row.insertCell();
              cell.setAttribute("contenteditable", "true");
              cell.textContent = data[i][key];
            }
          }
        }

        /* This function is activated when clicking on the "allocate employees" button next to a shift.
         * This function is presenting the relevant employees that can be allocated into the dropdown menu 
         * at the bottom of the page
         * INPUT: objectId shiftId
         * OUTPUT: Null
         */
        async function allocateEmployeeToSihft(shiftId)
        {
          console.log (shiftId);
          let employeesDropDown = document.getElementById("employeesDropDown");
          let shiftIdInput = document.getElementById("shiftIdInput");
          shiftIdInput.value = shiftId;
          employees = await axios.get(`http://localhost:3000/shifts?idOfShift=${shiftId}`,
          {headers: { 'Accept': 'application/json' }})
          console.log(JSON.stringify(employees.data));
          employees = employees.data;
          let dropdown = document.getElementById("employeesDropDown");
          dropdown.innerHTML = "";
          employees.forEach(employee => {
            let option = document.createElement("option");
            option.value = employee.idEmployee;
            option.textContent = employee.nameEmployee;
            dropdown.appendChild(option);
          });
        }

        async function submitEmployeeAllocation()
        {
          let shiftIdInput = document.getElementById("shiftIdInput");
          shiftIdInput = shiftIdInput.value;
          let employeeToAlloc = document.getElementById("employeesDropDown");
          employeeToAlloc = employeeToAlloc.value;
          let allocatedData= {
            shift: shiftIdInput,
            employee: employeeToAlloc
          }
          axios.post('http://localhost:3000/shifts', allocatedData);
          getShifts();
        }
      </script>
    </body>

</html>