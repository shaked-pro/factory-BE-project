<html>

<body onload="getEmployees()">
  <h1>Employees</h1>

  <table id="mongoTable">
    <thead>
      <tr>
        <th>Department Name</th>
        <!--where key is department Id get the department name from DB-->
        <th>Full Name</th>
        <th>Shifts</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data will be dynamically inserted here -->
    </tbody>
  </table>
  </br>
  </br>
  <label for="dropdown">Choose a department:</label>
  <select id="dropdown" onchange="handleDropdownChange()">
    <option value="HR">HR</option>
    <option value="Development">Development</option>
    <option value="Operations">Operations</option>
    <option value="Product">Product</option>
    <option value="Management">Management</option>
  </select>
  </br>
  </br>
  <button onclick="logout()">Log-Out</button>
  </br>
  <button onclick="addEmployeeRedirect()">New Employee</button>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    console.log("reached the script of the employee html");
    // async function tokenTest(){   const URL = "http://localhost:3000/employee";
    // const headers = {     'Authorization': `Bearer ${token}`,     'Accept':
    // 'application/json'   };   await axios.get(URL, {headers}); }

    /*DB MANAGEMENT FUNCTIONS*/

    //getting all employees from db
    async function getEmployees() {
      console.log('sending request to employeeController');
      let employeeAndShiftsData;
      let headers = {
        "collectemployeedata": "true"
      }
      employeeAndShiftsData = await axios.get('http://localhost:3000/employee', {
        headers
      });
      employeeAndShiftsData = employeeAndShiftsData.data;
      console.log(
        "employeeData:" + typeof employeeAndShiftsData + "employeeData[1]=" + JSON.stringify(employeeAndShiftsData)
      );
      let tableBody = document.querySelector("#mongoTable tbody");
      generateTable(tableBody, employeeAndShiftsData);
    }

    //generating a table to put the data in
    async function generateTable(table, data) {
      table.innerHTML = ""; // Clear existing rows
      for (let i = 0; i < Object.keys(data).length; i++) {
        let row = table.insertRow();
        for (let key in data[i]) {
          if (key === "fullName") {
            let cell = row.insertCell();
            let link = document.createElement("a");
            link.href = "http://localhost:3000/employee";
            link.textContent =(data[i][key]);
            link.onclick = function (
            event) { //preventing th link from sending a regular request to the employees controller
              event.preventDefault();
              goToEditEmployeePage(link.textContent);
            };
            cell.appendChild(link);
          }
          else if (key === "_id")
          {
            continue;
          }
          else if (key === "Department_id")
          {
            continue;
          }
          else if (key === "departmentName") {
            let cell = row.insertCell();
            let link = document.createElement("a");
            link.href = "http://localhost:3000/employee";
            link.textContent = data[i][key];
            link.onclick = function (
              event) { //preventing th link from sending a regular request to the employees controller
                event.preventDefault();
                goToEditDepartmentPage(link.textContent);
              };
             cell.appendChild(link);
         }
          else if (key === "shift_id") 
          {
            let cell = row.insertCell();
            cell.textContent = data[i][key];
          }
          else if (key === "Start_Work_Year")
          {
            continue;
          }
          else if (key === "First_Name" || key ==="Last_Name")
          {
            continue;
          }
          else {
            let cell = row.insertCell();
            cell.textContent = data[i][key];
          }
        }
      }
    }

    //Handeling the dropdown selection of the user
    async function handleDropdownChange() {
      let selectedDepartment = document.getElementById("dropdown").value;
      let headers ={
        "departmentfilter": selectedDepartment
      }
      console.log ("dropdown selection : "+selectedDepartment);
      let departmentEmployees =await axios.get ("http://localhost:3000/employee" , {headers});
      console.log (JSON.stringify(departmentEmployees));
      departmentEmployees = departmentEmployees.data;
      let tableBody = document.querySelector("#mongoTable tbody");
      await generateTable(tableBody, departmentEmployees);
    }

    /*REDIRECT FUNCTIONS*/

    //Returning the user to the login screen
    async function logout() {
      console.log("got to the logout function");
      await axios.get('http://localhost:3000/user');
      location.href = 'http://localhost:3000/';
    }
    //Redirecting to new employee page
    async function addEmployeeRedirect() {
      console.log("got to the new employee redirect func");
      location.href = 'http://localhost:3000/employee/addemployee'
    }
    //Redirecting to edit employee page
    async function goToEditEmployeePage(name) {
      window.location.href = `http://localhost:3000/employee/editEmployee?name=${name}`;
    }
    //Redirecting to edit department page
    async function goToEditDepartmentPage(departmentName) {
      window.location.href = `http://localhost:3000/departments/editDepartment?department=${departmentName}`;
    }
  </script>
</body>

</html>